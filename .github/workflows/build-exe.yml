name: Build Portable Windows App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download portable Python
      run: |
        curl -L -o python_embed.zip https://www.python.org/ftp/python/3.10.11/python-3.10.11-embed-amd64.zip
        Expand-Archive -Path python_embed.zip -DestinationPath python_portable

    - name: Install pip
      run: |
        curl -L -o get-pip.py https://bootstrap.pypa.io/get-pip.py
        ./python_portable/python.exe get-pip.py

    - name: Install dependencies
      run: |
        ./python_portable/Scripts/pip.exe install -r requirements.txt

    - name: Create the final app folder
      run: |
        New-Item -ItemType Directory -Force -Path "CryptoApp"
        Copy-Item -Path "./python_portable/*" -Destination "./CryptoApp/python" -Recurse
        Copy-Item -Path "./pages" -Destination "./CryptoApp/pages" -Recurse
        Copy-Item -Path "*.py" -Destination "./CryptoApp"
        Copy-Item -Path "requirements.txt" -Destination "./CryptoApp"

    - name: Create the run script
      run: |
        $run_script = '@echo off
        echo Starting CryptoApp... please wait.
        cd /d "%~dp0"
        python\\python.exe -m streamlit run "1_ðŸ“ˆ_Dashboard.py"
        pause'
        $run_script | Out-File -FilePath "./CryptoApp/run.bat" -Encoding utf8

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: CryptoApp-Portable
        path: CryptoApp
